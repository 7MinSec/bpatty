# Forensics

## Getting started / quick refs
A few links to check out:

* [System Resource Utilization Monitor](https://isc.sans.edu/forums/diary/System+Resource+Utilization+Monitor/21927/)

* [SANS Windows intrusion detection cheat sheet](https://pen-testing.sans.org/retrieve/windows-cheat-sheet.pdf)

* [Google Rapid Response Framework](https://github.com/google/grr-doc/blob/master/quickstart.adoc)

##Linux
* [Apache: Extending and Analyzing the Access Log](https://www.netnea.com/cms/apache-tutorial-5_extending-access-log/)

## Windows
*The info below is based on the BHIS Webcast you should definitely check out [here](https://www.youtube.com/watch?v=HcUMXxyYsnw&app=desktop)*!

### What network communication is happening?

Look at file shares: `net view \\127.0.0.1`

Who has an open session with this machine? `net session`

Which sessions does this machine have open with other systems? `net use`

What's the NetBIOS and TCP/IP activity look like? `nbtstat -S`

`netstat -naob` - the *o* give process IDs, the *b* gives us EXEs that are running

Look for weird listening TCP/UDP ports:

`netstat -na`

To run this in "continuously update" mode:

`netstat -na 5` or add the *o* flag to show ownership of process id: `netstat -nao 5`

Is the firewall running?

* XP/2003: `netsh firewall show config`

* 7/10: `netsh advfirewall show currentprofile`


`tasklist /m /fi "pid eq NUMBER-OF-PID"` will show DLLs loaded into the given executable 

`wmnic process where processid=NUMBER-OF-PID get commandline` will show the actual executable that's running the given process

## Checking a system for possible communication with known bad IPs

Run `netstat -naob > netstat.txt` then run the file against the [DNS blacklists tool from BHIS](https://bitbucket.org/ethanr/dns-blacklists) with:

`./dns_blacklists.py ./bad_lists/ ./check`

(The *netstat.txt* should be in the `/check` directory)

## Analyzing running services

`services.msc` - the basic services control panel

`net start` - shows services that are currently started

`sc query | more` - services in finer detail

`tasklist /svc` - helps map out which services are running out of which parent process

## Check registry for signs of persistence:

`HKLM\Software\Windows\CurrentVersion\Run`
`HKLM\Software\Windows\CurrentVersion\Runonce`
`HKLM\Software\Windows\CurrentVersion\RunonceEx`

(Explore these both in *HKLM* and *HKCU*)

[Autoruns](https://technet.microsoft.com/en-us/sysinternals/bb963902.aspx) will help you find startup items as well.

## Check for strange users and groups

`lusermgr.msc` - click groups, double-click Administrators

`net user` - list of available users

`net localgroup administrators` - lists out the admin groups

## Find unusual files

Look for files larger than 10 meg:

`FOR /R C:\ %i in (*) do @if %~zi gtr 10000000 echo %i %~zi`

In the GUI:

* XP/2003: *Start->Search->For Files and Folders-->Search Options-->Size-->At Least 10000KB*

* Win 7/10: Explorer search box, then type "size:>10M"

## Finding scheduled tasks

`schtasks`

Look for unusual tasks, especially those running as Admin/SYSTEM (or blank username)

The "at" command shows tasks that were scheduled using the *at* command

## Event log analysis
Download [check-critical-events.ps1](https://www.dropbox.com/sh/gb6k64cm3m641td/AADWA4TvjHcJXw5YUVT8g-PVa/check-critical-events.ps1?dl=0) 

Note: with the [Shadowbrokers fiasco](https://en.wikipedia.org/wiki/The_Shadow_Brokers), we need to be aware that there *may* be a tool out there that can selectivelly delete nuke Windows logs on the fly without a reboot or system instability (!).

### Security Windows event IDs to look for:

* Security 4720 - User account created
* Security 4722 - user account enabled
* Security 4724 - password reset
* Security 4738 - user account change
* Security 4732 - account added or removed from a group
* Security 1102 - Audit log cleared

### System Windows event IDs:

* System 7030 - basic service ops
* System 7045 - service installed
* System 1056 - DHCP oddities
* System 10000 - Com Functionality (see SubTee's sites)
* System 20001 - device driver installation
* System 20002 - remote access
* System 20003 - service install

## *Do* try this at home!
Head to [http://tinyurl.com/504-extra](http://tinyurl.com/504-extra) and download the [504lab-32.exe](https://www.dropbox.com/sh/gb6k64cm3m641td/AACAAzyzjYoySuR64xslLLF8a/504lab-32bit.exe?dl=0) to practice your skills in detecting backdoors!
